
# 概要
統計調査からユーザーが美術館に対して、求めていることをレビュー指標として取り入れることにより、美術館に対して的確な評価を行う。

# 選定の流れ
統計調査の該当の質問項目の中かから、重視している質問項目を抽出して、評価指標とする。

```mermaid
flowchart LR
%% this is a comment A -- text --> B{node}
   評価項目の選定  --> 評価方法  --> 実装
   ```
# 評価項目の選定

| 質問項目                                                                    | 評価 |
|-----------------------------------------------------------------------------|------|
| - [ ] 興味のあるテーマの展覧会を開催していること                            | 73.2 |
| - [ ] 好きな作品・作家の展覧会を開催していること                            | 69.9 |
| - [x] アクセスのよい場所にあること                                          | 37.2 |
| - [ ] 世界的に有名な作品・作家の展覧会を開催していること                    | 34.4 |
| - [x] チケット売り場や会場内が混雑しておらず、ゆっくり観られること          | 21.3 |
| - [ ] チケットが入手しやすいかどうか （ネット販売・予約など）               | 14.6 |
| - [x] 美術館の建築・デザインに魅力があること                                | 14.4 |
| - [ ] 周辺に楽しめるお店・施設などがあること                                | 11.5 |
| - [ ] TVや各種メディア （新聞・雑誌など）で注目される話題の展覧会であること | 11.2 |
| - [ ] 知人や友人の評価や、SNSなどネット上での評判が良いこと                 | 10.8 |
| - [x] 魅力的なオリジナルグッズが買えること                                  | 9.8  |
| - [ ] 魅力的なレストランやカフェが併設されていること                        | 9.2  |
| - [ ] 訪れたことのない・初めて行く美術館であること                          | 7.7  |
| - [ ] 開館時間が長く、夜も開いていること                                    | 7.3  |
| - [ ] 展示以外体験コーナーや企画、イベントなどに興味があること              | 7.3  |
| - [ ] 写真撮影ができること                                                  | 3.7  |
| - [ ] その他                                                                | 1.2  |

# 評価方法
- 普通にレビュー評価にする
    - 展示の評価
    - 外見の評価
    - アクセスの評価
    - ショップの評価

| 評価項目                                                            | 選定理由                                         |
|---------------------------------------------------------------------|--------------------------------------------------|
| - [x]  アクセスのよい場所にあること                                 | 場所に対する評価                                 |
| - [ ]  チケット売り場や会場内が混雑しておらず、ゆっくり観られること | 曜日による差があるので場所に対する評価とならない |
| - [x]  美術館の建築・デザインに魅力があること                       | 場所に対する評価                                 |
| - [x]  魅力的なオリジナルグッズが買えること                         | 場所に対するひょうか                             |

# 実装

- カラムの追加
- 平均値(ユーザー)を表示するアルゴリズム
- 平均値(全ユーザー)を表示するアルゴリズム

```mermaid
flowchart LR
A["カラムの追加"]  --> B["平均値(ユーザー)を表示するアルゴリズム"]  --> C["平均値(全ユーザー)を表示するアルゴリズム"] 
```

## カラムの追加
- 4カラムをそれぞれを区別できるように追加する
- それぞれに対応した入力フォーム、出力ビューを作成する


``docker compose exec app rails g migration AddColumnsToReview``

```
add_column :reviews, :exhibition_rate, :float
add_column :reviews, :museum_design_rate, :float
add_column :reviews, :access_rate, :float
add_column :reviews, :museum_shop_rate, :float
```

| 種類         | 具体のファイル                              |
|--------------|---------------------------------------------|
| 入力フォーム | review/_form.html.erb/_ratingforms.html.erb |

| カラム名           | 対象となるデータ |
|--------------------|------------------|
| exhibition_rate    | 展示の評価       |
| museum_design_rate | 外見の評価       |
| access_rate        | アクセスの評価   |
| museum_shop_rate   | ショップの評価   |

<!--exhibition_rate   -->
<!--museum_design_rate-->
<!--access_rate       -->
<!--museum_shop_rate  -->

## 平均値(ユーザー)を表示するアルゴリズム
- ユーザーの評価の平均値を表示するビューを選択する
- 表示ビューの作成

| モデル | ビュー | 対象の有無 |
|--------|--------|------------|
| Review | index  | [x] 有無   |
| Review | show   | [x] 有無   |
| Museum | index  | [ ] 有無   |
| Museum | show   | [ ] 有無   |

## 平均値(全ユーザー)を表示するアルゴリズム
- ユーザーの評価の平均値を表示するビューを選択する
- 表示ビューの作成

| モデル | ビュー | 対象の有無 |
|--------|--------|------------|
| Review | index  | [ ] 有無   |
| Review | show   | [ ] 有無   |
| Museum | index  | [ ] 有無   |
| Museum | show   | [ ] 有無   |

# 実装結果
## 実装概要
今回の平均値は二種類存
- レビューごとの平均値
- 美術館ごとの平均値
今回はレビュー内での平均値を実装した。

## 実装詳細
ビューからモデル内のインスタンスメソッドを呼び出すようにした。
railsのインスタンスメソッド内で、インスタンス属性を指定した場合、その属性値を出力するようになっていることに注意する(参照:[インスタンスメソッドについてて](./インスタンスメソッドに変数を渡す必要がない理由.md) )。

- 平均値算出ロジックの実装
```
  def calculate_average_rate
    if museum_shop_rate.present? && exhibition_rate.present? && museum_design_rate.present? && access_rate.present?
      ratings = [museum_shop_rate, exhibition_rate, museum_design_rate, access_rate] # 各カラムを配列に格納
      average_rate = (ratings.compact.sum / ratings.size.to_f).round(1)
    else
      average_rate = 0 # 必要に応じてデフォルト値を設定
    end
    average_rate
  end
```

- 表示用ビューの編集
```
      <p><%= Review.human_attribute_name(:rating01) %>: <%= review.calculate_average_rate %></p>
```
